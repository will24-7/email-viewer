<!DOCTYPE html>
<html>
<head>
    <title>Email Analysis System</title>
    <!-- Load Supabase before other scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/iife/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [Previous styles remain exactly the same...] */
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Debug Info (will be hidden in production) -->
    <div id="debugInfo" class="fixed top-0 left-0 bg-black text-green-500 p-4 font-mono text-sm z-50"></div>

    <div id="loading" class="loading">
        <div class="loading-content">
            <i class="fas fa-circle-notch fa-spin fa-3x mb-4"></i>
            <div class="text-lg mt-4">Processing Data...</div>
        </div>
    </div>

    <!-- [Rest of your HTML remains exactly the same until the script tag] -->

    <script>
        // Debug logging function
        function debug(msg) {
            console.log(msg);
            document.getElementById('debugInfo').textContent = msg;
        }

        // Initialize Supabase
        debug('Initializing Supabase...');
        const supabaseUrl = 'https://zhodxnwzlxpmywnsokts.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpob2R4bnd6bHhwbXl3bnNva3RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA5NjAyNzUsImV4cCI6MjA0NjUzNjI3NX0.tomM3nzGpKRJ4pxC4O9s-QgInRf1eI-JtpYxQEiC3Lk';
        
        // Make sure Supabase is available
        if (!window.supabase) {
            debug('Error: Supabase not loaded');
            alert('Error: Required library not loaded. Please refresh the page.');
        }

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        debug('Supabase initialized');

        // Hide loading screen immediately
        document.getElementById('loading').style.display = 'none';
        debug('Loading screen hidden');

        // Rest of your functions
        function cleanEmail(text) {
            // [Previous cleanEmail function remains the same]
        }

        async function processEmail() {
            const input = document.getElementById('emailInput');
            const content = input.value.trim();
            
            if (!content) return;

            document.getElementById('loading').style.display = 'flex';
            debug('Processing email...');

            try {
                const messages = cleanEmail(content);
                debug('Email cleaned, sending to Supabase...');

                const { data, error } = await supabase
                    .from('email_chains')
                    .insert([
                        { 
                            content: { original: content },
                            messages: messages
                        }
                    ])
                    .select();

                if (error) throw error;
                debug('Data saved to Supabase');

                // Display the chain
                // [Rest of your display code remains the same]

                input.value = '';
                debug('Process complete');
            } catch (error) {
                debug('Error: ' + error.message);
                console.error('Error:', error);
                alert('Error processing email: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Remove loadChains function for now to simplify debugging
    </script>
</body>
</html>
