<script>
    // Initialize Supabase client with timeout and retry options
    const { createClient } = supabase;
    const supabaseClient = createClient('https://zhodxnwzlxpmywnsokts.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpob2R4bnd6bHhwbXl3bnNva3RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA5NjAyNzUsImV4cCI6MjA0NjUzNjI3NX0.tomM3nzGpKRJ4pxC4O9s-QgInRf1eI-JtpYxQEiC3Lk', 
        {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            },
            realtime: {
                timeout: 10000,
                params: {
                    eventsPerSecond: 10
                }
            }
        }
    );

    let chainCount = 0;

    // Debug auth state
    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('Supabase auth event:', event);
        console.log('Session:', session);
    });

    function updateClock() {
        const now = new Date();
        document.getElementById('currentTime').textContent = 
            now.toLocaleTimeString('en-US', { hour12: false });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function toggleLoading(show) {
        const loadingElement = document.getElementById('loading');
        if (show) {
            loadingElement.classList.remove('hidden');
            // Add a timeout to automatically hide the loading spinner after 15 seconds
            setTimeout(() => {
                if (!loadingElement.classList.contains('hidden')) {
                    loadingElement.classList.add('hidden');
                    document.getElementById('chainCounter').textContent = 
                        'System Error - Operation timed out. Please refresh the page.';
                }
            }, 15000);
        } else {
            loadingElement.classList.add('hidden');
        }
    }

    function sanitizeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function cleanEmail(text) {
        if (!text) return [];
        
        let messages = text.split(/(?=On [A-Za-z]{3},? [A-Za-z]{3} \d{1,2}, \d{4}|On \d{1,2}\/\d{1,2}\/\d{2,4}|From:|Begin forwarded message:|>)/g);
        
        return messages.map(msg => {
            if (!msg.trim()) return '';
            
            msg = msg
                .replace(/^(From|To|Sent|Date|Subject|Cc|Bcc):.*$/gm, '')
                .replace(/Begin forwarded message:.*$/gm, '')
                .replace(/On .* wrote:$/gm, '')
                .replace(/On .* at .*, .* wrote:$/gm, '')
                .replace(/^--\s*\n[\s\S]*?(?=\n|$)/gm, '')
                .replace(/Best regards,[\s\S]*?(?=\n|$)/gim, '')
                .replace(/Regards,[\s\S]*?(?=\n|$)/gim, '')
                .replace(/Thank you,[\s\S]*?(?=\n|$)/gim, '')
                .replace(/Thanks,[\s\S]*?(?=\n|$)/gim, '')
                .replace(/^>+\s*/gm, '')
                .replace(/This email and any attachments.*$/gm, '')
                .replace(/CONFIDENTIALITY NOTICE:.*$/gm, '')
                .replace(/Disclaimer:.*$/gm, '')
                .replace(/\n{3,}/g, '\n\n');
                
            return msg.trim();
        }).filter(msg => msg.length > 0);
    }

    // Add timeout promise
    const timeout = (ms) => {
        return new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Request timed out')), ms)
        );
    };

    async function checkSupabaseConnection() {
        try {
            const { data, error } = await Promise.race([
                supabaseClient.from('email_chains').select('count'),
                timeout(5000)
            ]);
            if (error) throw error;
            console.log('Supabase connection successful');
        } catch (error) {
            console.error('Supabase connection error:', error);
            document.getElementById('chainCounter').textContent = 'System Error - Database connection failed';
            throw error;
        }
    }

    async function processEmail() {
        const input = document.getElementById('emailInput');
        const content = input.value.trim();
        
        if (!content) {
            alert('Please enter email content');
            return;
        }

        toggleLoading(true);
        
        try {
            const messages = cleanEmail(content);
            
            if (messages.length === 0) {
                throw new Error('No valid messages found in the email content');
            }

            const { data, error } = await Promise.race([
                supabaseClient
                    .from('email_chains')
                    .insert([{
                        content: { original: content },
                        messages: messages
                    }])
                    .select(),
                timeout(10000)
            ]);

            if (error) throw error;

            const conversationHTML = messages.map((msg, idx) => `
                <div class="message-block ${idx % 2 === 0 ? 'message-received' : 'message-sent'}">
                    <div class="message-arrow"></div>
                    <div class="text-sm text-emerald-400 mb-2">
                        <i class="fas ${idx % 2 === 0 ? 'fa-arrow-right' : 'fa-arrow-left'} mr-2"></i>
                        Message ${idx + 1}
                    </div>
                    <div class="message-content">${sanitizeHTML(msg)}</div>
                </div>
            `).join('');

            const chainHTML = `
                <div class="tech-card rounded-xl p-8" id="chain-${chainCount + 1}">
                    <div class="mb-6 pb-4 border-b border-emerald-900">
                        <h3 class="text-2xl font-bold tech-header text-emerald-400 mb-2">
                            Conversation ${chainCount + 1}
                        </h3>
                        <div class="flex items-center text-sm text-gray-400 space-x-4">
                            <div>
                                <i class="fas fa-clock text-emerald-500 mr-2"></i>
                                ${new Date().toLocaleString()}
                            </div>
                            <div>
                                <i class="fas fa-comments text-emerald-500 mr-2"></i>
                                ${messages.length} messages
                            </div>
                        </div>
                    </div>
                    ${conversationHTML}
                </div>
            `;

            document.getElementById('chainContainer').insertAdjacentHTML('afterbegin', chainHTML);
            chainCount++;
            document.getElementById('chainCounter').textContent = 
                `System Active - ${chainCount} Chain${chainCount !== 1 ? 's' : ''} Processed`;
            
            input.value = '';
        } catch (error) {
            console.error('Error:', error);
            alert(`Failed to process email chain: ${error.message}`);
        } finally {
            toggleLoading(false);
        }
    }

    async function loadChains() {
        toggleLoading(true);
        
        try {
            const result = await Promise.race([
                supabaseClient
                    .from('email_chains')
                    .select('*')
                    .order('created_at', { ascending: false }),
                timeout(10000)
            ]);

            if (!result || !result.data) {
                throw new Error('No data received from database');
            }

            const { data, error } = result;

            if (error) throw error;

            chainCount = data.length;
            
            if (data.length === 0) {
                document.getElementById('chainCounter').textContent = 'System Ready - No chains found';
                document.getElementById('chainContainer').innerHTML = '';
                return;
            }

            const chainsHTML = data.map((chain, index) => {
                const conversationHTML = chain.messages.map((msg, idx) => `
                    <div class="message-block ${idx % 2 === 0 ? 'message-received' : 'message-sent'}">
                        <div class="message-arrow"></div>
                        <div class="text-sm text-emerald-400 mb-2">
                            <i class="fas ${idx % 2 === 0 ? 'fa-arrow-right' : 'fa-arrow-left'} mr-2"></i>
                            Message ${idx + 1}
                        </div>
                        <div class="message-content">${sanitizeHTML(msg)}</div>
                    </div>
                `).join('');

                return `
                    <div class="tech-card rounded-xl p-8" id="chain-${index + 1}">
                        <div class="mb-6 pb-4 border-b border-emerald-900">
                            <h3 class="text-2xl font-bold tech-header text-emerald-400 mb-2">
                                Conversation ${index + 1}
                            </h3>
                            <div class="flex items-center text-sm text-gray-400 space-x-4">
                                <div>
                                    <i class="fas fa-clock text-emerald-500 mr-2"></i>
                                    ${new Date(chain.created_at).toLocaleString()}
                                </div>
                                <div>
                                    <i class="fas fa-comments text-emerald-500 mr-2"></i>
                                    ${chain.messages.length} messages
                                </div>
                            </div>
                        </div>
                        ${conversationHTML}
                    </div>
                `;
            }).join('');

            document.getElementById('chainContainer').innerHTML = chainsHTML;
            document.getElementById('chainCounter').textContent = 
                `System Active - ${chainCount} Chain${chainCount !== 1 ? 's' : ''} Processed`;

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('chainCounter').textContent = `System Error - ${error.message}`;
            document.getElementById('chainContainer').innerHTML = 
                '<div class="tech-card rounded-xl p-8 text-center text-red-500">Failed to load data. Please refresh the page.</div>';
        } finally {
            toggleLoading(false);
        }
    }

    async function initializeApp(maxRetries = 3) {
        let retries = 0;
        
        while (retries < maxRetries) {
            try {
                await checkSupabaseConnection();
                await loadChains();
                return;
            } catch (error) {
                retries++;
                console.error(`Connection attempt ${retries} failed:`, error);
                if (retries === maxRetries) {
                    document.getElementById('chainCounter').textContent = 'System Error - Could not connect to database';
                    toggleLoading(false);
                }
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retrying
            }
        }
    }

    // Initialize the app with the new retry mechanism
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });
</script>
