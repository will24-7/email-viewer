<!DOCTYPE html>
<html>
<head>
    <title>Email Conversation Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [Previous styles remain similar...] */

        .message-block {
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 12px;
            position: relative;
            max-width: 90%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .message-sent {
            background: rgba(6, 78, 59, 0.4);
            border: 1px solid rgba(16, 185, 129, 0.3);
            margin-left: auto;
            margin-right: 2rem;
        }

        .message-received {
            background: rgba(31, 41, 55, 0.4);
            border: 1px solid rgba(75, 85, 99, 0.3);
            margin-right: auto;
            margin-left: 2rem;
        }

        .message-arrow {
            position: absolute;
            top: 1rem;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .message-sent .message-arrow {
            right: -16px;
            border-left-color: rgba(16, 185, 129, 0.3);
        }

        .message-received .message-arrow {
            left: -16px;
            border-right-color: rgba(75, 85, 99, 0.3);
        }

        .message-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: rgba(16, 185, 129, 0.8);
            margin-bottom: 0.5rem;
        }

        .message-content {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #f3f4f6;
        }

        .conversation-divider {
            text-align: center;
            position: relative;
            margin: 2rem 0;
        }

        .conversation-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(16, 185, 129, 0.2), 
                transparent
            );
            z-index: 1;
        }

        .divider-text {
            background: #000000;
            padding: 0 1rem;
            color: #10b981;
            position: relative;
            z-index: 2;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains similar...] -->

    <script>
        const BIN_ID = 'YOUR_BIN_ID'; // We'll get this after setting up JSONbin
        const API_KEY = 'YOUR_API_KEY'; // We'll get this after setting up JSONbin

        function cleanEmail(text) {
            // Split into messages based on common email patterns
            let messages = text.split(/(?=On [A-Za-z]{3},? [A-Za-z]{3} \d{1,2}, \d{4}|On \d{1,2}\/\d{1,2}\/\d{2,4}|From:|Begin forwarded message:|>)/g);
            
            return messages.map(msg => {
                // Remove email headers
                msg = msg.replace(/^(From|To|Sent|Date|Subject|Cc|Bcc):.*$/gm, '');
                
                // Remove forwarded message headers
                msg = msg.replace(/Begin forwarded message:.*$/gm, '');
                
                // Remove timestamps and email clients
                msg = msg.replace(/On .* wrote:$/gm, '');
                msg = msg.replace(/On .* at .*, .* wrote:$/gm, '');
                
                // Remove signatures
                msg = msg.replace(/^--\s*\n[\s\S]*?(?=\n|$)/gm, '');
                msg = msg.replace(/Best regards,[\s\S]*?(?=\n|$)/gim, '');
                msg = msg.replace(/Regards,[\s\S]*?(?=\n|$)/gim, '');
                msg = msg.replace(/Thank you,[\s\S]*?(?=\n|$)/gim, '');
                msg = msg.replace(/Thanks,[\s\S]*?(?=\n|$)/gim, '');
                
                // Remove quoted text markers
                msg = msg.replace(/^>+\s*/gm, '');
                
                // Remove excessive whitespace
                msg = msg.replace(/\n{3,}/g, '\n\n');
                
                // Remove common email footers
                msg = msg.replace(/This email and any attachments.*$/gm, '');
                msg = msg.replace(/CONFIDENTIALITY NOTICE:.*$/gm, '');
                msg = msg.replace(/Disclaimer:.*$/gm, '');
                
                return msg.trim();
            }).filter(msg => msg.length > 0);
        }

        async function processEmail() {
            const input = document.getElementById('emailInput');
            const content = input.value.trim();
            
            if (content) {
                const button = document.querySelector('.cyber-button');
                button.classList.add('processing');
                
                // Clean and process the email chain
                const messages = cleanEmail(content);
                
                // Create the conversation HTML
                const conversationHTML = messages.map((msg, idx) => `
                    <div class="message-block ${idx % 2 === 0 ? 'message-received' : 'message-sent'}">
                        <div class="message-arrow"></div>
                        <div class="message-time">
                            <i class="fas ${idx % 2 === 0 ? 'fa-arrow-right' : 'fa-arrow-left'} mr-2"></i>
                            Message ${idx + 1}
                        </div>
                        <div class="message-content">${msg}</div>
                    </div>
                `).join('');
                
                const chainHTML = `
                    <div class="tech-card rounded-xl p-8" id="chain-${chainCount}">
                        <div class="message-header mb-6">
                            <h3 class="text-2xl font-bold tech-header text-emerald-400 mb-2">
                                Conversation ${chainCount}
                            </h3>
                            <div class="flex items-center text-sm text-gray-400 space-x-4">
                                <div>
                                    <i class="fas fa-clock text-emerald-500 mr-2"></i>
                                    ${new Date().toLocaleString()}
                                </div>
                                <div>
                                    <i class="fas fa-comments text-emerald-500 mr-2"></i>
                                    ${messages.length} messages
                                </div>
                            </div>
                        </div>
                        ${conversationHTML}
                    </div>
                `;
                
                // Store in JSONbin
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY,
                            'X-Bin-Versioning': false
                        },
                        body: JSON.stringify({
                            chains: [...existingChains, {
                                id: chainCount,
                                timestamp: new Date().toISOString(),
                                messages: messages
                            }]
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to save data');
                    
                    document.getElementById('chainContainer').insertAdjacentHTML('afterbegin', chainHTML);
                    chainCount++;
                    input.value = '';
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Failed to save the conversation. Please try again.');
                }
                
                button.classList.remove('processing');
            }
        }

        // Load existing chains on page load
        async function loadChains() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                existingChains = data.record.chains || [];
                
                existingChains.forEach(chain => {
                    // [Display existing chains similar to processEmail function]
                });
                
                chainCount = existingChains.length;
                document.getElementById('chainCounter').textContent = 
                    `System Active - ${chainCount} Chain${chainCount !== 1 ? 's' : ''} Processed`;
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        window.onload = loadChains;
    </script>
</body>
</html>
